<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Music Playlist Organiser</title>

    <!-- jQuery for AJAX and DOM manipulation -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    <!-- Bootstrap for styling -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
</head>
<body>
<div class="container mt-4">
    <h1>Music Playlist Organiser</h1>

    <!-- Top control buttons -->
    <div class="mb-3" id="topButtons">
        <button id="showCreateButton" onclick="showCreate()" class="btn btn-primary mr-2">Create</button>
        <button onclick="showCreatePlaylist()" class="btn btn-success mr-2">Create Playlist</button>
        <button onclick="showPlaylists()" class="btn btn-info">Show Playlists</button>
    </div>

    <!-- Table displaying all tracks -->
    <div>
        <table class="table table-bordered" id="trackTable">
            <thead class="thead-light">
                <tr>
                    <th>ID</th>
                    <th>Title</th>
                    <th>Artist</th>
                    <th>Genre</th>
                    <th>Play Count</th>
                    <th>Listeners</th>
                    <th>Update</th>
                    <th>Delete</th>
                    <th>Add</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Playlist Table (Hidden initially) -->
    <div id="playlistTableDiv" style="display: none;">
        <h2>Playlists</h2>
        <table class="table table-bordered" id="playlistTable">
            <thead class="thead-light">
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Update</th>
                    <th>Delete</th>
                    <th>View Tracks</th>
                </tr>
            </thead>
            <tbody>
                <!-- Dynamic content to be added here -->
            </tbody>
        </table>
    </div>
    
    <!-- Form for creating/updating tracks -->
    <div id='createUpdateForm' style="display: none" class="mt-4">
        <h2><span id="createLabel">Create a</span> <span id="updateLabel">update</span> Track</h2>
        <input type="hidden" name="id"/>
        <div class="form-group">
            <label>Title</label>
            <input type="text" name="title" class="form-control" />
            <small id="titleError" class="text-danger" style="display: none;">Title is required</small>
        </div>
        <div class="form-group">
            <label>Artist</label>
            <input type="text" name="artist" class="form-control" />
            <small id="artistError" class="text-danger" style="display: none;">Artist is required</small>
        </div>
        <div class="form-group">
            <label>Genre</label>
            <input type="text" name="genre" class="form-control" />
        </div>
        <div class="form-group">
            <label>Play Count</label>
            <input type="number" name="play_count" class="form-control" />
        </div>
        <div class="form-group">
            <label>Listeners</label>
            <input type="number" name="listeners" class="form-control" />
        </div>
        <div>
            <button id="doCreateButton" onclick="doCreate()" class="btn btn-success">Create</button>
            <button id="doUpdateButton" onclick="doUpdate()" class="btn btn-warning">Update</button>
        </div>
    </div>

    <!-- Playlist Creation Form (Hidden initially) -->
    <div id="createPlaylistForm" style="display: none;" class="mt-4">
        <h2>Create Playlist</h2>
        <div class="form-group">
            <label>Playlist Name</label>
            <input type="text" name="playlist_name" class="form-control" />
            <small id="playlistNameError" class="text-danger" style="display: none;">Playlist name is required</small>
        </div>
        <div>
            <button id="doCreatePlaylistButton" onclick="doCreatePlaylist()" class="btn btn-success">Create Playlist</button>
        </div>
    </div>

</div>

<script>

    // Show Playlist Creation Form
    function showCreatePlaylist() {
        document.getElementById('createPlaylistForm').style.display = "block";
        document.getElementById('playlistTableDiv').style.display = "none";
        document.getElementById('trackTable').style.display = "none"; // Hide the track table
        document.getElementById('createUpdateForm').style.display = "none"; // Hide the track create/update form
        document.getElementById('topButtons').style.display = "none"; // Hide the top buttons
    }

    // Show Playlists Table
    function showPlaylists() {
        document.getElementById('createPlaylistForm').style.display = "none"; 
        document.getElementById('playlistTableDiv').style.display = "block";
        document.getElementById('trackTable').style.display = "none"; 
        document.getElementById('createUpdateForm').style.display = "none";
        document.getElementById('topButtons').style.display = "none";
        getAllPlaylists();
    }

    function showCreate(){
        document.getElementById('showCreateButton').style.display="none";
        document.getElementById('trackTable').style.display="none";
        document.getElementById('createUpdateForm').style.display="block";
        document.getElementById('topButtons').style.display = "none";

        document.getElementById('createLabel').style.display="inline";
        document.getElementById('updateLabel').style.display="none";

        document.getElementById('doCreateButton').style.display="block";
        document.getElementById('doUpdateButton').style.display="none";

        var form = document.getElementById('createUpdateForm');
        form.querySelector('input[name="id"]').value = '';
        form.querySelector('input[name="title"]').value = '';
        form.querySelector('input[name="artist"]').value = '';
        form.querySelector('input[name="genre"]').value = '';
        form.querySelector('input[name="play_count"]').value = '';
        form.querySelector('input[name="listeners"]').value = '';
    }

    function showViewAll(){
        document.getElementById('showCreateButton').style.display="block";
        document.getElementById('trackTable').style.display="block";
        document.getElementById('createUpdateForm').style.display="none";
        document.getElementById('topButtons').style.display = "block";
    }

    function showUpdate(buttonElement){
        document.getElementById('showCreateButton').style.display="none"
        document.getElementById('trackTable').style.display="none"
        document.getElementById('createUpdateForm').style.display="block"
        document.getElementById('topButtons').style.display = "none"

        document.getElementById('createLabel').style.display="none"
        document.getElementById('updateLabel').style.display="inline"

        document.getElementById('doCreateButton').style.display="none"
        document.getElementById('doUpdateButton').style.display="block"

        var rowElement = buttonElement.parentNode.parentNode
        var track = getTrackFromRow(rowElement)
        populateFormWithTrack(track)
    }

    function getTrackFromRow(row){
        return {
            id: row.cells[0].innerText,
            title: row.cells[1].innerText,
            artist: row.cells[2].innerText,
            genre: row.cells[3].innerText,
            play_count: row.cells[4].innerText,
            listeners: row.cells[5].innerText
        }
    }

    function populateFormWithTrack(track){
        var form = document.getElementById('createUpdateForm')
        form.querySelector('input[name="id"]').value = track.id
        form.querySelector('input[name="title"]').value = track.title
        form.querySelector('input[name="artist"]').value = track.artist
        form.querySelector('input[name="genre"]').value = track.genre
        form.querySelector('input[name="play_count"]').value = track.play_count
        form.querySelector('input[name="listeners"]').value = track.listeners
    }

    function doCreate() {
        var form = document.getElementById('createUpdateForm');

        var playCountRaw = form.querySelector('input[name="play_count"]').value;
        var listenersRaw = form.querySelector('input[name="listeners"]').value;

        var playCount = playCountRaw === "" ? 0 : parseInt(playCountRaw);
        var listeners = listenersRaw === "" ? 0 : parseInt(listenersRaw);

        var genreRaw = form.querySelector('input[name="genre"]').value;
        var genre = genreRaw.trim() === "" ? null : genreRaw.trim();

        var track = {
            title: form.querySelector('input[name="title"]').value,
            artist: form.querySelector('input[name="artist"]').value,
            genre: genre,
            play_count: playCount,
            listeners: listeners
        };

        // Clear error messages
        document.getElementById("titleError").style.display = 'none';
        document.getElementById("artistError").style.display = 'none';

        // Validation
        if (!track.title) {
            document.getElementById("titleError").style.display = 'block';
            return false;
        }

        if (!track.artist) {
            document.getElementById("artistError").style.display = 'block';
            return false;
        }

        $.ajax({
            type: 'POST',
            url: '/api/tracks',
            data: JSON.stringify(track),
            contentType: "application/json",
            success: function () {
                location.reload();
            },
            error: function(xhr) {
                if (xhr.status === 409) {
                    alert("This track already exists.");
                } else if (xhr.status === 400) {
                    alert("Invalid input.");
                } else {
                    alert("Something went wrong.");
                }
            }
        });
    }

    function doUpdate(){
        var form = document.getElementById('createUpdateForm')
        var id = form.querySelector('input[name="id"]').value
        var track = {
            title: form.querySelector('input[name="title"]').value,
            artist: form.querySelector('input[name="artist"]').value,
            genre: form.querySelector('input[name="genre"]').value,
            play_count: form.querySelector('input[name="play_count"]').value,
            listeners: form.querySelector('input[name="listeners"]').value
        }

        $.ajax({
            type: 'PUT',
            url: '/api/tracks/' + id,
            data: JSON.stringify(track),
            contentType: "application/json",
            success: function(){
                location.reload()
            },
            error: function(xhr) {
                if (xhr.status === 409) {
                    alert("Update failed: a track with the same title and artist already exists.");
                }
            }
        });
    }

    function doDelete(r){
        var row = r.parentNode.parentNode;
        var id = row.cells[0].innerText;

        $.ajax({
            type: 'DELETE',
            url: '/api/tracks/' + id,
            success: function(){
                location.reload()
            }
        });
    }

        // Create a new playlist
        function doCreatePlaylist() {
            var form = document.getElementById('createPlaylistForm');
            var playlistName = form.querySelector('input[name="playlist_name"]').value;

            if (!playlistName) {
                document.getElementById("playlistNameError").style.display = 'block';
                return false;
            }

            $.ajax({
                type: 'POST',
                url: '/api/playlists',
                data: JSON.stringify({ name: playlistName }),
                contentType: "application/json",
                success: function () {
                    // Clear the input field after success
                    form.querySelector('input[name="playlist_name"]').value = '';
                    location.reload();
                },
                error: function(xhr) {
                    if (xhr.status === 409) {
                        alert("Playlist with this name already exists.");
                    } else if (xhr.status === 400) {
                        alert("Invalid input.");
                    } else {
                        alert("Something went wrong.");
                    }
                }
            });
        }


    // Fetches all tracks from the backend and populates the table
    function getAll(){
        $.ajax({
            type: 'GET',
            url: '/api/tracks',
            success: function(response){
                var trackTable = document.getElementById('trackTable').getElementsByTagName('tbody')[0];
                response.forEach(track => {
                    var row = trackTable.insertRow();
                    row.insertCell(0).innerText = track.id;
                    row.insertCell(1).innerText = track.title;
                    row.insertCell(2).innerText = track.artist;
                    row.insertCell(3).innerText = track.genre;
                    row.insertCell(4).innerText = track.play_count;
                    row.insertCell(5).innerText = track.listeners;
                    row.insertCell(6).innerHTML = "<button onclick='showUpdate(this)' class='btn btn-warning'>Update</button>";
                    row.insertCell(7).innerHTML = "<button onclick='doDelete(this)' class='btn btn-danger'>Delete</button>";
                    row.insertCell(8).innerHTML = "<button onclick='addTrackToPlaylist(this)' class='btn btn-info'>Add to Playlist</button>";
                });
            }
        });
    }

    // Fetches all playlists from the backend and populates the playlist table
    function getAllPlaylists() {
        $.ajax({
            type: 'GET',
            url: '/api/playlists',
            success: function(response) {
                var playlistTable = document.getElementById('playlistTable').getElementsByTagName('tbody')[0];
                playlistTable.innerHTML = ''; // Clear existing rows
                response.forEach(playlist => {
                    var row = playlistTable.insertRow();
                    row.insertCell(0).innerText = playlist.id;
                    row.insertCell(1).innerText = playlist.name;
                    row.insertCell(2).innerHTML = "<button onclick='showUpdatePlaylist(this)' class='btn btn-warning'>Update</button>";
                    row.insertCell(3).innerHTML = "<button onclick='doDeletePlaylist(this)' class='btn btn-danger'>Delete</button>";
                    row.insertCell(4).innerHTML = "<button onclick='viewPlaylistTracks(this)' class='btn btn-info'>View Tracks</button>";
                });
            }
        });
    }


    getAll(); // Fetch and display the track data when the page loads
</script>
</body>
</html>
